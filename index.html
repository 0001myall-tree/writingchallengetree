<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>글쓰기 루틴 챌린지 입력기 — 스프린트/마라톤/아이디어</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@500&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  :root{
    /* 고급 톤다운 팔레트 */
    --bg:#f6f5f3;
    --card:#ffffffcc;          /* 살짝 투명감 */
    --ink:#2b2b2b;
    --muted:#7b7b7b;

    --brand:#6b4de6;           /* 포인트 컬러 보랏빛 */
    --brand2:#a077ff;
    --ring:rgba(17, 16, 30, .06);

    --ok:#1a7f37;
    --danger:#e23e57;

    /* 유리카드/그라데이션 깊이감 */
    --grad:linear-gradient(135deg, #6b4de6, #a077ff);
    --grad-soft:linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.3));
  }

  /* 베이스 */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:'Noto Sans KR', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background:
      radial-gradient(1200px 600px at 10% -10%, #efe9ff 0%, transparent 60%),
      radial-gradient(1000px 500px at 100% 0%, #ffe9f0 0%, transparent 55%),
      var(--bg);
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }

  /* 헤더 */
  header{
    position:relative;
    text-align:center; padding:48px 16px 40px; color:#fff;
    background:var(--grad);
    overflow:hidden;
  }
  header::after{
    content:""; position:absolute; inset:auto -20% -80% -20%; height:180%;
    background:radial-gradient(60% 60% at 50% 40%, rgba(255,255,255,.25), transparent 60%);
    filter:blur(40px);
  }
  header h1{
    margin:0 0 10px; font-family:'Noto Serif KR', serif;
    font-size:32px; letter-spacing:.2px
  }
  header p{margin:0; opacity:.9}

  /* 레이아웃 카드(유리카드 느낌) */
  .wrap{max-width:920px; margin:-28px auto 28px; padding:0 16px}
  .card{
    backdrop-filter:saturate(160%) blur(6px);
    background:var(--card);
    border:1px solid rgba(255,255,255,.65);
    border-radius:16px;
    box-shadow:0 20px 40px var(--ring);
    padding:24px; margin-bottom:20px;
  }

  /* 행/스택 */
  .row{display:flex; flex-wrap:wrap; gap:12px; align-items:center}
  .stack{display:flex; flex-direction:column; gap:16px}

  h2,h3{
    font-family:'Noto Serif KR', serif; margin:0 0 14px;
    color:#3f35a4; letter-spacing:.2px
  }
  label{font-weight:700; font-size:14px; color:#504e62}

  /* 폼 요소 */
  select,input[type="number"]{
    padding:12px 14px; border:1px solid #e6e2f4; border-radius:12px; font-size:15px;
    background:#fff; min-width:140px; transition:border-color .15s, box-shadow .15s;
  }
  select:focus, input[type="number"]:focus{
    outline:none; border-color:#c7b9ff; box-shadow:0 0 0 5px rgba(163,140,255,.18)
  }

  /* 버튼 */
  button{
    background:var(--grad); color:#fff; border:none;
    border-radius:28px; padding:12px 20px; font-weight:800; letter-spacing:.2px;
    cursor:pointer; transition:.18s transform,.18s box-shadow, filter .18s;
    box-shadow:0 10px 18px rgba(107,77,230,.18);
  }
  button:hover{transform:translateY(-1px); box-shadow:0 16px 28px rgba(107,77,230,.22)}
  button:active{transform:translateY(0)}
  button.ghost{
    background:#ffffff; color:#3b3b3b; border:1px solid #e9e6f7;
    box-shadow:0 6px 14px rgba(0,0,0,.04)
  }
  button.danger{background:linear-gradient(135deg, #e23e57, #ff6a7b); box-shadow:0 10px 18px rgba(226,62,87,.18)}

  /* 메타/텍스트 */
  .muted{color:var(--muted)}
  .center{text-align:center}
  .success{color:var(--ok); font-weight:800}
  .fail{color:var(--danger); font-weight:800}
  .hr{height:1px; background:linear-gradient(90deg, #eee 0%, #f6f5ff 50%, #eee 100%); margin:18px 0}

.hidden { display: none !important; }

  /* 통계 카드 */
  .stats{display:flex; gap:16px; flex-wrap:wrap; justify-content:center; margin-top:8px}
  .stat{
    background:var(--grad-soft); border:1px solid rgba(255,255,255,.7);
    border-radius:12px; padding:12px 14px; min-width:160px; text-align:center;
    box-shadow:0 8px 18px var(--ring)
  }
  .timer{font-size:24px; font-weight:900; color:#e23e57; letter-spacing:.5px}

  /* 에디터 */
  textarea{
    width:100%; min-height:360px; padding:18px 16px; font-size:16.5px; line-height:1.7;
    border:1px solid #ece8ff; border-radius:14px; resize:vertical; background:#fff;
    transition:border-color .15s, box-shadow .15s;
  }
  textarea:focus{border-color:#c7b9ff; box-shadow:0 0 0 6px rgba(163,140,255,.16)}

  /* 진행률 바 */
  .progress-wrap{width:100%; background:#f3f0ff; border-radius:12px; overflow:hidden; height:14px; border:1px solid #e8e3ff}
  .progress-bar{height:100%; width:0%; background:linear-gradient(90deg, #6b4de6, #a077ff); transition:width .2s ease}
  .progress-line{display:flex; justify-content:space-between; font-size:13px; color:#5d5778; margin-bottom:8px}

  /* 난이도 블록(더 또렷하게 구분) */
  .difficulty-block{
    display:flex; align-items:center; gap:12px; padding:12px 0
  }
  .difficulty-block + .difficulty-block{
    border-top:1px dashed #e6e2f4; margin-top:8px; padding-top:18px
  }

  /* 공유 버튼 */
  .share-buttons{display:flex; justify-content:center; gap:12px; margin-top:18px; flex-wrap:wrap}
  .share-buttons button{
    padding:10px 16px; border-radius:22px; font-size:14px;
    background:#fff; color:#3f35a4; border:1px solid #e8e3ff;
    box-shadow:0 6px 12px rgba(63,53,164,.06)
  }
  .share-buttons button:hover{filter:brightness(1.02)}

  /* 반응형 */
  @media (max-width:640px){
    header h1{font-size:24px}
    .stat{min-width:140px}
    textarea{min-height:320px}
  }

  /* 다크 모드(시스템 연동) */
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#12121a; --ink:#e9e9ef; --muted:#a6a6b3;
      --card:rgba(22,22,32,.6); --ring:rgba(0,0,0,.5);
    }
    header::after{filter:blur(60px); opacity:.6}
    .card{border:1px solid rgba(255,255,255,.12)}
    select, input[type="number"], textarea{background:#171726; color:var(--ink); border-color:#2a2740}
    textarea:focus{box-shadow:0 0 0 6px rgba(107,77,230,.25)}
    .progress-wrap{background:#1c1b2a; border-color:#2a2740}
    .share-buttons button{background:#181828; color:#cfcaff; border-color:#2a2740}
    .difficulty-block + .difficulty-block{border-top-color:#2a2740}
  }
</style>
</head>
<body>
  <header>
    <h1>글쓰기 루틴 챌린지 입력기</h1>
    <p>스프린트 / 마라톤 / 아이디어 · Hard/Soft 모드 · 결과 공유</p>
  </header>

  <div class="wrap">

    <!-- 모드 선택 -->
    <div class="card" id="modeCard">
      <h2>모드 선택</h2>
      <div class="stack">
        <div class="row">
          <button id="btnSprint">스프린트 모드</button>
          <!-- ▼ 문구도 5초로 수정 -->
          <span class="muted">· 3/5/10/20/30분 · <b>5초</b> 멈추면 실패</span>
        </div>
        <div class="row">
          <button id="btnMarathon">마라톤 모드</button>
          <span class="muted">· 목표 글자수 + 40/60/90/120분 · 미달 시 실패</span>
        </div>
        <div class="row">
          <button id="btnIdea">아이디어 모드</button>
          <span class="muted">· 10/20/30분 · <b>1분</b> 무입력 시 실패</span>
        </div>
      </div>
    </div>

    <!-- 난이도 선택 -->
    <div class="card hidden" id="difficultyCard">
      <h3>난이도 선택</h3>
      <div class="difficulty-block">
        <button id="btnHard">🔥 Hard</button>
        <span class="muted">실패 시 원고 삭제</span>
      </div>
      <div class="difficulty-block">
        <button id="btnSoft">🌱 Soft</button>
        <span class="muted">실패해도 원고 보존 (메시지만 표시)</span>
      </div>
    </div>

    <!-- 스프린트 설정 -->
    <div class="card hidden" id="sprintSetup">
      <h3>스프린트 설정</h3>
      <div class="row">
        <label for="sprintDuration">세션 시간</label>
        <select id="sprintDuration">
          <option value="180">3분</option>
          <option value="300" selected>5분</option>
          <option value="600">10분</option>
          <!-- ▼ 추가: 20분, 30분 -->
          <option value="1200">20분</option>
          <option value="1800">30분</option>
        </select>
        <button id="startSprint">시작</button>
        <button class="ghost" id="backFromSprint">뒤로</button>
      </div>
      <div class="hr"></div>
      <!-- ▼ 문구도 5초로 수정 -->
      <p class="muted">타이핑이 <b>5초 이상</b> 멈추면 즉시 실패.</p>
    </div>

    <!-- 마라톤 설정 -->
    <div class="card hidden" id="marathonSetup">
      <h3>마라톤 설정</h3>
      <div class="row">
        <label for="targetChars">목표 글자수</label>
        <input type="number" id="targetChars" min="500" step="100" value="4000" />
        <label for="marathonDuration" style="margin-left:10px">세션 시간</label>
        <select id="marathonDuration">
          <option value="2400" selected>40분</option>
          <option value="3600">1시간</option>
          <option value="5400">1시간 30분</option>
          <option value="7200">2시간</option>
        </select>
        <button id="startMarathon">시작</button>
        <button class="ghost" id="backFromMarathon">뒤로</button>
      </div>
      <div class="hr"></div>
      <p class="muted"><b>시간 내 목표 글자수 미달</b> 시 실패 처리.</p>
    </div>

    <!-- 아이디어 설정 -->
    <div class="card hidden" id="ideaSetup">
      <h3>아이디어 모드 설정</h3>
      <div class="row">
        <label for="ideaDuration">세션 시간</label>
        <select id="ideaDuration" aria-label="아이디어 시간">
          <option value="600" selected>10분</option>
          <option value="1200">20분</option>
          <option value="1800">30분</option>
        </select>
        <button id="startIdea">시작</button>
        <button class="ghost" id="backFromIdea">뒤로</button>
      </div>
      <div class="hr"></div>
      <p class="muted">규칙: <b>1분 이상</b> 키 입력이 없으면 즉시 실패. (글자수 목표 없음)</p>
    </div>

    <!-- 글쓰기 화면 -->
    <div class="card hidden" id="writingCard">
      <h3 id="sessionTitle">세션 진행중</h3>
      <div class="stats">
        <div class="stat"><div class="muted">남은 시간</div><div class="timer" id="timeLeft">--:--</div></div>
        <div class="stat"><div class="muted">현재 글자수</div><div id="charCount">0</div></div>
        <div class="stat hidden" id="goalBox"><div class="muted">목표 글자수</div><div id="goalChars">0</div></div>
      </div>

      <div id="progressWrap" class="hidden">
        <div class="progress-line">
          <span id="progressLabel">진행: 0 / 0 (0%)</span>
          <span class="muted" id="paceHint"></span>
        </div>
        <div class="progress-wrap" aria-label="진행률">
          <div class="progress-bar" id="progressBar"></div>
        </div>
      </div>

      <div class="hr"></div>
      <textarea id="editor" placeholder="여기에 원고/아이디어를 작성하세요..."></textarea>
      <p id="statusLine" class="center muted">입력 대기 중…</p>
      <div class="center">
        <button class="danger" id="giveUp">포기(즉시 종료)</button>
      </div>
    </div>

    <!-- 결과 화면 -->
    <div class="card hidden" id="resultCard">
      <h3 id="resultHeadline">결과</h3>
      <p id="resultDetail" class="center"></p>
      <div class="center" style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:8px">
        <button id="restart">다시 시작</button>
      </div>
      <div class="share-buttons">
        <button id="shareKakao">카카오톡</button>
        <button id="shareTwitter">X(트위터)</button>
        <button id="shareCopy">📋 복사</button>
      </div>
    </div>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== DOM =====
      const modeCard = document.getElementById('modeCard');
      const difficultyCard = document.getElementById('difficultyCard');
      const sprintSetup = document.getElementById('sprintSetup');
      const marathonSetup = document.getElementById('marathonSetup');
      const ideaSetup = document.getElementById('ideaSetup');
      const writingCard = document.getElementById('writingCard');
      const resultCard = document.getElementById('resultCard');

      const btnSprint = document.getElementById('btnSprint');
      const btnMarathon = document.getElementById('btnMarathon');
      const btnIdea = document.getElementById('btnIdea');

      const btnHard = document.getElementById('btnHard');
      const btnSoft = document.getElementById('btnSoft');

      const backFromSprint = document.getElementById('backFromSprint');
      const backFromMarathon = document.getElementById('backFromMarathon');
      const backFromIdea = document.getElementById('backFromIdea');

      const startSprintBtn = document.getElementById('startSprint');
      const startMarathonBtn = document.getElementById('startMarathon');
      const startIdeaBtn = document.getElementById('startIdea');

      const sprintDurationSel = document.getElementById('sprintDuration');
      const marathonDurationSel = document.getElementById('marathonDuration');
      const targetCharsInput = document.getElementById('targetChars');
      const ideaDurationSel = document.getElementById('ideaDuration');

      const sessionTitle = document.getElementById('sessionTitle');
      const timeLeftEl = document.getElementById('timeLeft');
      const charCountEl = document.getElementById('charCount');
      const goalBox = document.getElementById('goalBox');
      const goalCharsEl = document.getElementById('goalChars');

      const progressWrap = document.getElementById('progressWrap');
      const progressBar = document.getElementById('progressBar');
      const progressLabel = document.getElementById('progressLabel');
      const paceHint = document.getElementById('paceHint');

      const editor = document.getElementById('editor');

// ▼ 초안 저장 키
const DRAFT_KEY = 'novel:autosave';

// ▼ 초안 저장/복원 유틸
function saveDraft(){
  try { localStorage.setItem(DRAFT_KEY, editor.value); } catch(e) {}
}
function loadDraft(){
  try {
    const v = localStorage.getItem(DRAFT_KEY);
    if (v != null) editor.value = v;
  } catch(e) {}
}

// ▼ 창 닫기/새로고침 시 자동 저장
window.addEventListener('beforeunload', saveDraft);

const statusLine = document.getElementById('statusLine');

      const giveUpBtn = document.getElementById('giveUp');

      const resultHeadline = document.getElementById('resultHeadline');
      const resultDetail = document.getElementById('resultDetail');
      const restartBtn = document.getElementById('restart');

      const shareTwitter = document.getElementById('shareTwitter');
      const shareKakao = document.getElementById('shareKakao');
      const shareCopy = document.getElementById('shareCopy');

      // ===== 상태 =====
      let mode = null;          // 'sprint' | 'marathon' | 'idea'
      let difficulty = null;    // 'hard' | 'soft'
      let totalSeconds = 0;
      let remain = 0;
      let timerId = null;
      let idleTimeoutId = null;
      const IDEA_IDLE_LIMIT = 60; // 아이디어: 1분 무입력 실패
      const SPRINT_IDLE_LIMIT = 5; // ▼ 스프린트: 5초 무입력 실패 (변경)

      // ▼ 추가: 포커스/가드 상태
      let isPaused = false;
      let sessionEnded = false;   // 성공/실패 등 최종 종료 여부

      // ===== 유틸 =====
      const fmt = s => { const m=Math.floor(s/60), sec=s%60; return `${m}:${sec<10?'0'+sec:sec}`; };
      const show = el => el.classList.remove('hidden');
      const hide = el => el.classList.add('hidden');

      function resetToHome(){
        clearInterval(timerId); timerId = null;
        clearTimeout(idleTimeoutId); idleTimeoutId = null;

        editor.disabled = false;
        editor.value = ''; editor.oninput = null; editor.onkeydown = null;
        editor.removeAttribute('data-target');

        timeLeftEl.textContent = '--:--';
        charCountEl.textContent = '0';
        goalCharsEl.textContent = '0';
        statusLine.textContent = '입력 대기 중…'; statusLine.className = 'center muted';
        progressBar.style.width = '0%'; progressLabel.textContent = '진행: 0 / 0 (0%)'; paceHint.textContent = '';

        hide(writingCard); hide(resultCard); hide(sprintSetup); hide(marathonSetup); hide(ideaSetup); hide(difficultyCard);
        show(modeCard);

        mode = null; difficulty = null; totalSeconds = 0; remain = 0;


        // ▼ 상태 초기화
        isPaused = false;
        sessionEnded = false;
      }

      // ===== 네비게이션 =====
      btnSprint.onclick = () => { mode = 'sprint'; hide(modeCard); show(difficultyCard); };
      btnMarathon.onclick = () => { mode = 'marathon'; hide(modeCard); show(difficultyCard); };
      btnIdea.onclick = () => { mode = 'idea'; hide(modeCard); show(difficultyCard); };

      btnHard.onclick = () => { difficulty = 'hard'; goSetup(); };
      btnSoft.onclick = () => { difficulty = 'soft'; goSetup(); };

      function goSetup(){
        hide(difficultyCard);
        if(mode==='sprint') show(sprintSetup);
        else if(mode==='marathon') show(marathonSetup);
        else if(mode==='idea') show(ideaSetup);
      }

      backFromSprint.onclick = () => { hide(sprintSetup); show(modeCard); mode=null; difficulty=null; };
      backFromMarathon.onclick = () => { hide(marathonSetup); show(modeCard); mode=null; difficulty=null; };
      backFromIdea.onclick = () => { hide(ideaSetup); show(modeCard); mode=null; difficulty=null; };

      // ===== 시작 =====
      startSprintBtn.onclick = () => {
        totalSeconds = parseInt(sprintDurationSel.value,10);
        startSession();
      };
      startMarathonBtn.onclick = () => {
        const target = parseInt(targetCharsInput.value,10);
        if (isNaN(target) || target < 500){ alert('목표 글자수를 500자 이상으로 입력하세요.'); return; }
        totalSeconds = parseInt(marathonDurationSel.value,10);
        startSession(target);
      };
      startIdeaBtn.onclick = () => {
        totalSeconds = parseInt(ideaDurationSel.value,10);
        startSession();
      };

      function startSession(targetChars=null){
        hide(modeCard); hide(difficultyCard); hide(sprintSetup); hide(marathonSetup); hide(ideaSetup);
        show(writingCard);

        // ▼ 세션 가드 초기화
        sessionEnded = false;
        isPaused = false;

        if(mode==='sprint'){
          sessionTitle.textContent = `스프린트 진행중 (${fmt(totalSeconds)}) — 5초 멈추면 실패`;
          hide(goalBox); hide(progressWrap);
        }else if(mode==='marathon'){
          sessionTitle.textContent = `마라톤 진행중 (${fmt(totalSeconds)}) — 목표 글자수 달성 필수`;
          goalCharsEl.textContent = String(targetChars);
          show(goalBox); show(progressWrap);
          editor.dataset.target = String(targetChars);
        }else{
          sessionTitle.textContent = `아이디어 모드 진행중 (${fmt(totalSeconds)}) — 1분 무입력 시 실패`;
          hide(goalBox); hide(progressWrap);
        }
editor.disabled = false;
editor.value = '';
loadDraft();  // ← 저장본 있으면 덮어쓰기
charCountEl.textContent = String(editor.value.length); // 복원된 길이 반영
statusLine.textContent = '입력 대기 중…';
statusLine.className = 'center muted';

editor.oninput = () => {
  saveDraft(); // ← 입력 시마다 자동 저장
  charCountEl.textContent = String(editor.value.length);
  if(mode==='sprint') resetIdle(SPRINT_IDLE_LIMIT);
  if(mode==='idea')   resetIdle(IDEA_IDLE_LIMIT);
  if(mode==='marathon') updateProgress();
};

        editor.onkeydown = () => {
          if(mode==='sprint') resetIdle(SPRINT_IDLE_LIMIT);     // ▼ 5초로 동작
          if(mode==='idea')   resetIdle(IDEA_IDLE_LIMIT);
        };

        remain = totalSeconds;
        timeLeftEl.textContent = fmt(remain);
        clearInterval(timerId); timerId = setInterval(tick,1000);

        if(mode==='sprint')  resetIdle(SPRINT_IDLE_LIMIT);      // ▼ 5초로 동작
        if(mode==='idea')    resetIdle(IDEA_IDLE_LIMIT);
        if(mode==='marathon') updateProgress();

        editor.focus();
      }

      function tick(){
        // ▼ 숨김/일시정지/포커스 이탈 중에는 진행 금지
        if (sessionEnded || isPaused || document.hidden || !document.hasFocus()) return;

        remain--;
        timeLeftEl.textContent = fmt(remain);
        if(mode==='marathon') updateProgress();

        if(remain<=0){
          clearInterval(timerId);
          // 종료 직전 혹시 남은 idle 타이머도 제거
          clearTimeout(idleTimeoutId); idleTimeoutId=null;
          if(mode==='sprint'){
            success(`스프린트 성공! ${fmt(totalSeconds)} 동안 멈추지 않았습니다.`);
          }else if(mode==='marathon'){
            const target = parseInt(editor.dataset.target || '0',10);
            const len = editor.value.length;
            if(len >= target){
              success(`마라톤 성공! ${fmt(totalSeconds)} 내에 ${len.toLocaleString()}자 작성 (목표 ${target.toLocaleString()}자).`);
            }else{
              fail(`마라톤 실패! ${fmt(totalSeconds)} 내에 ${len.toLocaleString()}자 / 목표 ${target.toLocaleString()}자 미달.`, true);
            }
          }else{
            success(`아이디어 모드 성공! ${fmt(totalSeconds)} 동안 멈추지 않고 브레인스토밍 완료.`);
          }
        }
      }

      function updateProgress(){
        const target = parseInt(editor.dataset.target || '0',10);
        if(!target){ hide(progressWrap); return; }
        const len = editor.value.length;
        const pct = Math.max(0, Math.min(100, Math.round((len/target)*100)));
        progressBar.style.width = pct + '%';
        progressLabel.textContent = `진행: ${len.toLocaleString()} / ${target.toLocaleString()} (${pct}%)`;
        if(remain > 0){
          const need = Math.max(0, target - len);
          const needPerMin = Math.ceil(need / (remain/60));
          paceHint.textContent = `필요 속도: 분당 ${needPerMin.toLocaleString()}자`;
        }else{
          paceHint.textContent = '';
        }
      }

      function resetIdle(seconds){
        clearTimeout(idleTimeoutId);
        const ruleText = (mode==='sprint') ? '5초 이상 멈추면 실패' : (mode==='idea') ? '1분 무입력 시 실패' : '';
        statusLine.textContent = `입력 중… (${ruleText})`;
        statusLine.className = 'center muted';
        idleTimeoutId = setTimeout(()=>{
          // ▼ 세션이 끝났거나 시간 종료된 뒤 지연 타이머가 깨어나면 무시
          if (sessionEnded || remain <= 0) return;
          if (mode==='sprint'){
            fail('스프린트 실패! 5초 이상 타이핑이 멈췄습니다.', true); // ▼ 메시지도 5초
          }else if(mode==='idea'){
            fail('아이디어 모드 실패! 1분 이상 입력이 없었습니다.', true);
          }
        }, seconds*1000);
      }

      function success(msg){
        // ▼ 중복/지연 성공 호출 방지
        if (sessionEnded) return;
        sessionEnded = true;

saveDraft(); // ✅ 최종본 명시 저장

        stopTimersKeepEditor();
        resultHeadline.textContent = '🎉 성공';
        resultHeadline.className = 'success center';
        resultDetail.textContent = msg + ' (원고는 아래 에디터에 그대로 보존됩니다)';
        show(resultCard);
      }

      function fail(msg, wipe=false){
        // ▼ 중복/지연 실패 호출 방지
        if (sessionEnded) return;
        // ▼ 탭이 숨김이거나 포커스가 없을 때는 실패 처리 금지
        if (document.hidden || !document.hasFocus()) return;

        sessionEnded = true;

        stopTimersKeepEditor();
        if(difficulty==='hard' && wipe){
          editor.value = '';
          charCountEl.textContent = '0';
          try { localStorage.removeItem(DRAFT_KEY); } catch(e) {}
          resultDetail.textContent = msg + ' (Hard 모드 — 원고가 삭제되었습니다)';
        }else{
saveDraft(); // ✅ Soft 실패(또는 hard이지만 wipe=false) 시 최종본 저장
          resultDetail.textContent = msg + ' (Soft 모드 — 원고가 보존됩니다)';
        }
        resultHeadline.textContent = '⚠️ 실패';
        resultHeadline.className = 'fail center';
        show(resultCard);
      }

      function stopTimersKeepEditor(){
        clearInterval(timerId);
        clearTimeout(idleTimeoutId);
        timerId = null; idleTimeoutId = null;
        editor.disabled = false;
        show(writingCard);
      }

      giveUpBtn.onclick = ()=>{
        if(confirm('정말 포기하시겠어요?')){
          fail('사용자 중단', true);
        }
      };

      restartBtn.onclick = resetToHome;

      // 공유
      function getShareText(){
        const baseUrl = (location.origin + location.pathname);
        return `${resultDetail.innerText}\n바로 해보기: ${baseUrl}`;
      }
      shareKakao.onclick = async ()=>{
        const text = getShareText();
        const shareData = { title:'글쓰기 루틴 챌린지 입력기', text, url: location.href };
        if(navigator.share){
          try{ await navigator.share(shareData); return; }catch(e){}
        }
        try{ await navigator.clipboard.writeText(text); alert('공유 텍스트가 복사됐어요! 카카오톡에 붙여넣기 하세요.'); }
        catch(e){ alert('복사 실패. 수동 복사 부탁드려요.'); }
      };
      shareTwitter.onclick = ()=>{ const t=encodeURIComponent(getShareText()); window.open(`https://twitter.com/intent/tweet?text=${t}`,'_blank'); };
      shareCopy.onclick = async ()=>{ try{ await navigator.clipboard.writeText(getShareText()); alert('결과가 복사되었습니다!'); }catch(e){ alert('복사 실패. 수동 복사 부탁드려요!'); } };

      // ▼ 일시정지/재개 로직
      function pauseSession(reason='포커스 이탈'){
        if (isPaused || sessionEnded) return;
        isPaused = true;
        clearInterval(timerId); timerId = null;
        clearTimeout(idleTimeoutId); idleTimeoutId = null;
        statusLine.textContent = `일시정지 (${reason}) — 창으로 돌아오면 자동 재개`;
        statusLine.className = 'center muted';
      }

      function resumeSession(){
        if (!isPaused || sessionEnded) return;
        isPaused = false;
        // 카운트다운 재개
        timerId = setInterval(tick, 1000);
        // 유휴감지 재개
        if (mode==='sprint') resetIdle(SPRINT_IDLE_LIMIT);
        if (mode==='idea')   resetIdle(IDEA_IDLE_LIMIT);
        statusLine.textContent = '입력 중…';
        statusLine.className = 'center muted';
      }

      // ▼ 탭/창 포커스에 따른 일시정지·재개 (글쓰기 화면에서만)
      document.addEventListener('visibilitychange', ()=>{
        if (sessionEnded || !writingCard || writingCard.classList.contains('hidden')) return;
        if (document.hidden) pauseSession('탭 숨김');
        else if (document.hasFocus()) resumeSession();
      });

      window.addEventListener('blur', ()=>{
        if (sessionEnded) return;
        if (!writingCard.classList.contains('hidden')) pauseSession('포커스 이탈');
      });
      window.addEventListener('focus', ()=>{
        if (sessionEnded) return;
        if (!writingCard.classList.contains('hidden') && !document.hidden) resumeSession();
      });
    });
  </script>
</body>
</html>


